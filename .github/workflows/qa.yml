name: Deploy Merchant Backend to QA

on:
  push:
    branches:
      - qa # Trigger on pushes to qa branch

jobs:
  deploy:
    name: Deploy to QA Droplet
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 'qa' branch
        uses: actions/checkout@v4
        with:
          ref: qa # Ensure we are checking out the qa branch

      - name: Setup SSH Key for QA
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.QA_DEPLOYMENT_SSH_PRIVATE_KEY }}

      - name: Add QA Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.QA_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Application Files & Run Setup on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.QA_HOST }}
          username: ${{ secrets.QA_DEPLOYER_USER }}
          key: ${{ secrets.QA_DEPLOYMENT_SSH_PRIVATE_KEY }}
          script: |
            set -e # Exit script immediately if any command fails
            # --- Server Variables ---
            APP_DIR="/home/${{ secrets.QA_DEPLOYER_USER }}/merchant-backend"
            REPO_URL="git@github.com:RocketShopIndia/merchant-backend.git"
            BRANCH="qa"
            PM2_APP_NAME="merchantApi"
            START_SCRIPT_COMMAND="npm run start"

            echo "### Starting QA Deployment for branch $BRANCH ###"

            # 1. Navigate/Create App Directory
            echo "1. Ensuring application directory exists: $APP_DIR"
            mkdir -p $APP_DIR
            cd $APP_DIR

            # 2. Clone or Update Repository
            echo "2. Updating repository from $REPO_URL branch $BRANCH..."
            if [ ! -d ".git" ] ; then
              echo "   Cloning repository..."
              git clone --branch $BRANCH $REPO_URL .
            else
              echo "   Fetching all remote changes and pruning old references..."
              git fetch --all --prune

              echo "   Checking out branch $BRANCH..."
              git checkout $BRANCH

              echo "   Resetting local branch to match remote..."
              git reset --hard origin/$BRANCH
            fi

            # 3. Create .env file from GitHub Secrets
            echo "3. Creating .env file for QA environment..."
            cat << EOF > .env
            # Auto-generated by GitHub Actions for QA ${GITHUB_RUN_ID}
            NODE_ENV=development # Set NODE_ENV for QA specifically
            PORT='${{ secrets.QA_PORT }}'
            DB_USER='${{ secrets.QA_DB_USER }}'
            DB_PASSWORD='${{ secrets.QA_DB_PASSWORD }}'
            DB_HOST='${{ secrets.QA_DB_HOST }}'
            DB_PORT='${{ secrets.QA_DB_PORT }}'
            DB_NAME='${{ secrets.QA_DB_NAME }}'
            DB_SSL='${{ secrets.QA_DB_SSL }}'
            SPACES_ACCESS_KEY_ID='${{ secrets.QA_SPACES_ACCESS_KEY_ID }}'
            SPACES_SECRET_KEY='${{ secrets.QA_SPACES_SECRET_KEY }}'
            SPACES_MEDIA_BUCKET='${{ secrets.QA_SPACES_MEDIA_BUCKET }}'
            JWT_SECRET='${{ secrets.QA_JWT_SECRET }}'
            JWT_REFRESH_SECRET='${{ secrets.QA_JWT_REFRESH_SECRET }}'
            SMS_COUNTRY_AUTH_KEY='${{ secrets.QA_SMS_COUNTRY_AUTH_KEY }}'
            SMS_COUNTRY_AUTH_TOKEN='${{ secrets.QA_SMS_COUNTRY_AUTH_TOKEN }}'
            SMS_COUNTRY_SENDER_ID='${{ secrets.QA_SMS_COUNTRY_SENDER_ID }}'
            ZOHO_SMTP_HOST='${{ secrets.QA_ZOHO_SMTP_HOST }}'
            ZOHO_SMTP_PORT='${{ secrets.QA_ZOHO_SMTP_PORT }}'
            ZOHO_EMAIL_API_KEY='${{ secrets.QA_ZOHO_EMAIL_API_KEY }}'
            ZOHO_SENDER_EMAIL='${{ secrets.QA_ZOHO_SENDER_EMAIL }}'
            ZOHO_SENDER_NAME='${{ secrets.QA_ZOHO_SENDER_NAME }}'
            RAZORPAY_KEY_ID='${{ secrets.QA_RAZORPAY_KEY_ID }}'
            RAZORPAY_KEY_SECRET='${{ secrets.QA_RAZORPAY_KEY_SECRET }}'
            RAZORPAY_CLIENT_ID='${{ secrets.QA_RAZORPAY_CLIENT_ID }}'
            RAZORPAY_CLIENT_SECRET='${{ secrets.QA_RAZORPAY_CLIENT_SECRET }}'
            RAZORPAY_REDIRECT_URI='${{ secrets.QA_RAZORPAY_REDIRECT_URI }}'
            RAZORPAY_SCOPES='${{ secrets.QA_RAZORPAY_SCOPES }}'
            RAZORPAY_WEBHOOK_SECRET='${{ secrets.QA_RAZORPAY_WEBHOOK_SECRET }}'
            ENCRYPTION_KEY='${{ secrets.QA_ENCRYPTION_KEY }}'
            EOF
            echo "   .env file created successfully."

            # 4. Install/Update Dependencies
            echo "4. Installing/Updating non-dev dependencies..."
            # Using --production is deprecated, using NODE_ENV is preferred
            # But for npm ci, this is how you install only production deps.
            npm ci --production

            # 6. Database Migrations (Ready to be uncommented)
            echo "6. Running database migrations..."
            npx knex migrate:latest

            # 7. Reload/Start App
            echo "7. Reloading/Starting application via pm2..."
            pm2 reload $PM2_APP_NAME || pm2 start "$START_SCRIPT_COMMAND" --name $PM2_APP_NAME

            # 8. Save PM2 List
            echo "8. Saving PM2 process list..."
            pm2 save

            echo "### QA Deployment Finished Successfully ###"