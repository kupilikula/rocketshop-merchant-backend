name: Deploy Merchant Backend to QA

on:
  push:
    branches:
      - develop # Trigger on pushes to the develop branch

jobs:
  deploy:
    name: Deploy to QA Droplet
    runs-on: ubuntu-latest
    # Optional: Define QA environment in GitHub for secrets grouping/rules
    # environment: qa

    steps:
      - name: Checkout 'develop' branch
        uses: actions/checkout@v4
        with:
          ref: develop # Make sure to check out the correct branch

      - name: Setup SSH Key for QA
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.QA_DEPLOYMENT_SSH_PRIVATE_KEY }} # Use a secret containing the private SSH key for QA server access

      - name: Add QA Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.QA_HOST }} >> ~/.ssh/known_hosts
#           Consider adding error checking or using a more secure method for known_hosts

      - name: Deploy Application Files & Run Setup on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.QA_HOST }}
          username: ${{ secrets.QA_DEPLOYER_USER }} # e.g., 'deployer'
          key: ${{ secrets.QA_DEPLOYMENT_SSH_PRIVATE_KEY }} # Same key as used in ssh-agent step
          script: |
            set -e # Exit script immediately if any command fails
#             --- Server Variables ---
            APP_DIR="/home/${{ secrets.QA_DEPLOYER_USER }}/apps/merchant-app" # Target directory on QA server
            REPO_URL="git@github.com:RocketShopIndia/merchant-backend.git" # Use SSH URL for private repos
            BRANCH="develop"
            PM2_APP_NAME="merchantApi" # Name used by PM2
            # IMPORTANT: Use your production start script (e.g., from package.json "start")
            START_SCRIPT_COMMAND="npm run start" # Adjust if different

            echo "### Starting QA Deployment for branch $BRANCH ###"

            # 1. Navigate/Create App Directory
            echo "1. Ensuring application directory exists: $APP_DIR"
            mkdir -p $APP_DIR
            cd $APP_DIR

            # 2. Clone or Update Repository
            echo "2. Updating repository from $REPO_URL branch $BRANCH..."
            if [ ! -d ".git" ] ; then
              echo "   Cloning repository..."
              git clone --branch $BRANCH $REPO_URL .
            else
              echo "   Fetching latest changes..."
              git checkout $BRANCH
              git fetch origin $BRANCH
              echo "   Resetting local branch to match origin/$BRANCH..."
              git reset --hard origin/$BRANCH # Force match remote commit
            fi

            # 3. Create .env file from GitHub Secrets
            echo "3. Creating .env file for QA environment..."
#             Using cat with Heredoc ('EOF') prevents immediate shell expansion inside the block
#             Secrets  are expanded by GitHub Actions *before* the script runs
#             Added single quotes around secrets for values that might contain special characters
            cat << EOF > .env
            # Auto-generated by GitHub Actions for QA ${GITHUB_RUN_ID}
            NODE_ENV=development
            PORT='${{ secrets.QA_PORT }}'

            # Database
            DB_USER='${{ secrets.QA_DB_USER }}'
            DB_PASSWORD='${{ secrets.QA_DB_PASSWORD }}'
            DB_HOST='${{ secrets.QA_DB_HOST }}'
            DB_PORT='${{ secrets.QA_DB_PORT }}'
            DB_NAME='${{ secrets.QA_DB_NAME }}'
            DB_SSL='${{ secrets.QA_DB_SSL }}' # e.g., 'true' or path if needed

            # DO Spaces
            SPACES_ACCESS_KEY_ID='${{ secrets.QA_SPACES_ACCESS_KEY_ID }}'
            SPACES_SECRET_KEY='${{ secrets.QA_SPACES_SECRET_KEY }}'

            # JWT
            JWT_SECRET='${{ secrets.QA_JWT_SECRET }}'
            JWT_REFRESH_SECRET='${{ secrets.QA_JWT_REFRESH_SECRET }}'

            # SMS Country
            SMS_COUNTRY_AUTH_KEY='${{ secrets.QA_SMS_COUNTRY_AUTH_KEY }}'
            SMS_COUNTRY_AUTH_TOKEN='${{ secrets.QA_SMS_COUNTRY_AUTH_TOKEN }}'
            SMS_COUNTRY_SENDER_ID='${{ secrets.QA_SMS_COUNTRY_SENDER_ID }}'

            # Razorpay (using QA/Test credentials)
            RAZORPAY_KEY_ID='${{ secrets.QA_RAZORPAY_KEY_ID }}'
            RAZORPAY_KEY_SECRET='${{ secrets.QA_RAZORPAY_KEY_SECRET }}'
            RAZORPAY_CLIENT_ID='${{ secrets.QA_RAZORPAY_CLIENT_ID }}'
            RAZORPAY_CLIENT_SECRET='${{ secrets.QA_RAZORPAY_CLIENT_SECRET }}'
            RAZORPAY_REDIRECT_URI='${{ secrets.QA_RAZORPAY_REDIRECT_URI }}' # e.g., https://api.qa.merchant.../callback
            RAZORPAY_SCOPES='${{ secrets.QA_RAZORPAY_SCOPES }}' # e.g., 'read_write'
            RAZORPAY_WEBHOOK_SECRET='${{ secrets.QA_RAZORPAY_WEBHOOK_SECRET }}'

            # Encryption Key
            ENCRYPTION_KEY='${{ secrets.QA_ENCRYPTION_KEY }}'

            # Add any other necessary QA environment variables here...

            EOF
            echo "   .env file created successfully."
            # ------------------------------------

            echo "4. Installing/Updating production dependencies..."
            # 'npm ci' is generally recommended over 'npm install' in CI/CD for reliability
            # '--production' skips devDependencies
            npm ci --production

#             Optional Build Step (if your app needs compiling, e.g., TypeScript)
#             echo "5. Running build process..."
#             npm run build

#            echo "6. Running database migrations..."
#            # Ensure your knexfile.js is configured to read from .env or process.env
#            npx knex migrate:latest --knexfile ./knexfile.js # Adjust path/command if needed

            echo "5. Reloading/Starting application via pm2..."
            # Use reload for zero-downtime restarts if possible. || start handles first deploy.
            # The --env qa flag can pass the environment name to pm2 ecosystem files if you use them
            pm2 reload $PM2_APP_NAME --env qa || pm2 start "$START_SCRIPT_COMMAND" --name $PM2_APP_NAME --env qa

            echo "6. Saving PM2 process list for persistence..."
            pm2 save

            echo "### QA Deployment Finished Successfully ###"