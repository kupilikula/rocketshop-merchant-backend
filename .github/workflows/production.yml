name: Deploy Merchant Backend to PROD

on:
  push:
    branches:
      - main # Trigger on pushes to main branch

jobs:
  deploy:
    name: Deploy to Production Droplet
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 'main' branch
        uses: actions/checkout@v4
        with:
          ref: main # Ensure we are checking out the main branch

      - name: Setup SSH Key for Production
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_DEPLOYMENT_SSH_PRIVATE_KEY }} # Use PROD specific secret

      - name: Add PROD Server to Known Hosts
        run: |
          # Ensure consistent indentation here (e.g., 10 spaces if 'run:' is at 8)
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Application Files & Run Setup on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_DEPLOYER_USER }} # e.g., 'deployer'
          key: ${{ secrets.PROD_DEPLOYMENT_SSH_PRIVATE_KEY }} # Same key as used in ssh-agent step
          # Script content starts below. Note the consistent indentation for each command line.
          # Assuming 'script: |' starts at indentation level 8 (adjust if different)
          # All lines like 'set -e', 'APP_DIR=...', 'echo ...', 'if...', 'cat...', 'npm...', 'pm2...'
          # should start at indentation level 10 or 12 (consistently).
          script: |
            set -e # Exit script immediately if any command fails
                        
            # --- Server Variables ---
            APP_DIR="/home/${{ secrets.PROD_DEPLOYER_USER }}/merchant-backend"
            REPO_URL="git@github.com:RocketShopIndia/merchant-backend.git"
            BRANCH="main"
            PM2_APP_NAME="merchantApi"
            START_SCRIPT_COMMAND="npm run start" # ADJUST if needed

            echo "### Starting PROD Deployment for branch $BRANCH ###"

            # 1. Navigate/Create App Directory
            echo "1. Ensuring application directory exists: $APP_DIR"
            mkdir -p $APP_DIR
            cd $APP_DIR

            # 2. Clone or Update Repository
            echo "2. Updating repository from $REPO_URL branch $BRANCH..."
            if [ ! -d ".git" ] ; then
              echo "   Cloning repository..."
              git clone --branch $BRANCH $REPO_URL .
            else
              echo "   Fetching latest changes..."
              git checkout $BRANCH
              git fetch origin $BRANCH
              echo "   Resetting local branch to match origin/$BRANCH..."
              git reset --hard origin/$BRANCH
            fi

            # 3. Create .env file from GitHub Secrets
            echo "3. Creating .env file for PROD environment..."
            cat << EOF > .env
            # Auto-generated by GitHub Actions for PROD ${GITHUB_RUN_ID}
            NODE_ENV=production # Set NODE_ENV for PROD specifically
            PORT='${{ secrets.PROD_PORT }}'
            DB_USER='${{ secrets.PROD_DB_USER }}'
            DB_PASSWORD='${{ secrets.PROD_DB_PASSWORD }}'
            DB_HOST='${{ secrets.PROD_DB_HOST }}'
            DB_PORT='${{ secrets.PROD_DB_PORT }}'
            DB_NAME='${{ secrets.PROD_DB_NAME }}'
            DB_SSL='${{ secrets.PROD_DB_SSL }}'
            SPACES_ACCESS_KEY_ID='${{ secrets.PROD_SPACES_ACCESS_KEY_ID }}'
            SPACES_SECRET_KEY='${{ secrets.PROD_SPACES_SECRET_KEY }}'
            SPACES_MEDIA_BUCKET='${{ secrets.PROD_SPACES_MEDIA_BUCKET }}'
            JWT_SECRET='${{ secrets.PROD_JWT_SECRET }}'
            JWT_REFRESH_SECRET='${{ secrets.PROD_JWT_REFRESH_SECRET }}'
            SMS_COUNTRY_AUTH_KEY='${{ secrets.PROD_SMS_COUNTRY_AUTH_KEY }}'
            SMS_COUNTRY_AUTH_TOKEN='${{ secrets.PROD_SMS_COUNTRY_AUTH_TOKEN }}'
            SMS_COUNTRY_SENDER_ID='${{ secrets.PROD_SMS_COUNTRY_SENDER_ID }}'
            ZOHO_SMTP_HOST='${{ secrets.PROD_ZOHO_SMTP_HOST }}'
            ZOHO_SMTP_PORT='${{ secrets.PROD_ZOHO_SMTP_PORT }}'
            ZOHO_EMAIL_API_KEY='${{ secrets.PROD_ZOHO_EMAIL_API_KEY }}'
            ZOHO_SENDER_EMAIL='${{ secrets.PROD_ZOHO_SENDER_EMAIL }}'
            ZOHO_SENDER_NAME='${{ secrets.PROD_ZOHO_SENDER_NAME }}'
            RAZORPAY_KEY_ID='${{ secrets.PROD_RAZORPAY_KEY_ID }}'
            RAZORPAY_KEY_SECRET='${{ secrets.PROD_RAZORPAY_KEY_SECRET }}'
            RAZORPAY_CLIENT_ID='${{ secrets.PROD_RAZORPAY_CLIENT_ID }}'
            RAZORPAY_CLIENT_SECRET='${{ secrets.PROD_RAZORPAY_CLIENT_SECRET }}'
            RAZORPAY_REDIRECT_URI='${{ secrets.PROD_RAZORPAY_REDIRECT_URI }}'
            RAZORPAY_SCOPES='${{ secrets.PROD_RAZORPAY_SCOPES }}'
            RAZORPAY_WEBHOOK_SECRET='${{ secrets.PROD_RAZORPAY_WEBHOOK_SECRET }}'
            ENCRYPTION_KEY='${{ secrets.PROD_ENCRYPTION_KEY }}'
            # Add any other necessary PROD environment variables here...
            EOF
            echo "   .env file created successfully."

            # 4. Install/Update Dependencies
            echo "4. Installing/Updating production dependencies..."
            npm ci --production

            # Optional Build Step
            # echo "5. Running build process..."
            # npm run build

            # 6. Database Migrations (Uncomment when ready)
            # echo "6. Running database migrations..."
            # Ensure knexfile uses dotenv or process.env correctly
             npx knex migrate:latest

            # 7. Reload/Start App
            echo "7. Reloading/Starting application via pm2..."
            pm2 reload $PM2_APP_NAME || pm2 start "$START_SCRIPT_COMMAND" --name $PM2_APP_NAME

            # 8. Save PM2 List
            echo "8. Saving PM2 process list..."
            pm2 save

            echo "### PROD Deployment Finished Successfully ###"